---
sidebar: sidebar
permalink: vmware/vmware-vvols-deploy.html
keywords: tr-4400, vvols, ontap, virtual volumes, deploy
summary: 
---
= Deploying vVols Storage
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ../media/

[.lead]
Creating vVols storage for your VMs involves several steps. These steps are simpler if you are using an ASA r2 system with ONTAP tools 10.3 or later.

The first two steps may not be needed for an existing vSphere environment that uses ONTAP for traditional datastores. You may already be using ONTAP tools for managing, automating, and reporting with your VMFS or traditional NFS based storage. These steps are covered in more detail in the following section:

. Create the Storage Virtual Machine (SVM) and its protocol configuration. Note that this may not be required for ASA r2 systems since they will typically already have a single SVM for data services. You will select NVMe/FC (ONTAP tools 9.13 only), NFSv3, NFSv4.1, iSCSI, FCP, or a mix of those options. NVMe/TCP and NVMe/FC may also be used for traditional VMFS datastores with ONTAP tools 10.3. You may use either ONTAP System Manager wizards, or the cluster shell command line.
* At least one LIF per node for each switch/fabric connection. As a best practice, create two or more per node for FCP, iSCSI, or NVMe-based protocols. One LIF per node is sufficient for NFS-based vVols, but this LIF should be protected by an LACP ifgroup.
* Volumes may be created at this time, but it is the best practice to let the _Provision Datastore_ wizard in ONTAP tools create them. The only exception to this rule is if you plan to use vVols replication with VMware Site Recovery Manager and ONTAP tools 9. This is easier to set up with pre-existing FlexVol volumes with existing SnapMirror relationships. Be mindful to not enable QoS on any volumes to be used for vVols as this is intended to be managed by SPBM and ONTAP tools.

. https://docs.netapp.com/us-en/ontap-tools-vmware-vsphere-10/deploy/ontap-tools-deployment.html[Deploy ONTAP tools for VMware vSphere] using the OVA downloaded from the NetApp Support Site.
. If you use the legacy ONTAP tools 9.x, you will need to deploy an appliance for each vCenter you plan to manage. ONTAP tools 10.0 and later supports multiple vCenter servers per appliance.
. ONTAP tools 10.3 deploys as a single node small-type appliance suitable for most non-vVols workloads.

[NOTE]
For vVols production use, it is recommended to https://docs.netapp.com/us-en/ontap-tools-vmware-vsphere-10/manage/edit-appliance-settings.html[scale-out ONTAP tools] 10.3 to the 3-node high availability (HA) configuration.

[NOTE]
In order to eliminate a single point of failure, create anti-affinity rules to prevent the ONTAP tools VMs from running together on the same host. After initial deployment, it's also optional, but a good idea, to use storage vMotion to separate them into different datastores. Read more about https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/vsphere-resource-management-8-0/using-drs-clusters-to-manage-resources/using-affinity-rules-without-vsphere-drs.html[Using Affinity Rules without vSphere DRS] or https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/vsphere-resource-management-8-0/using-drs-clusters-to-manage-resources/create-a-vm-vm-affinity-rule.html[Create a VM-VM Affinity Rule] Likewise, if you use storage DRS, create a storage DRS rule as per https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/add-a-vm-anti-affinity-rule.html[Add a VM Anti-Affinity Rule
].

[start=5]
. Configure ONTAP tools for your environment.
* ONTAP tools 9.13
** Add the ONTAP cluster to ONTAP tools under _Storage Systems_
*** While ONTAP tools and SRA support both cluster-level and SVM-level credentials, the VASA Provider supports only cluster-level credentials for storage systems. This is because many of the APIs used for vVols are only available at the cluster level. Therefore, if you plan to use vVols, you must add your ONTAP clusters using cluster-scoped credentials.
** If your ONTAP data LIFs are on different subnets from your VMkernel adapters, then you must add the VMkernel adapter subnets to the selected subnets list in the settings menu of ONTAP tools. By default, ONTAP tools will secure your storage traffic by only allowing local subnet access.
** The ONTAP tools comes with several pre-defined policies that may be used or see <<Managing VMs with policies>> for guidance on creating SCPs.
* ONTAP tools 10.3
** https://docs.netapp.com/us-en/ontap-tools-vmware-vsphere-10/configure/add-vcenter.html[Add vCenter Server instances] in the ONTAP tools manager UI.
** ONTAP tools 10.3 supports secure multitenancy. If you do not need secure multitenancy, you may simply https://docs.netapp.com/us-en/ontap-tools-vmware-vsphere-10/configure/add-storage-backend.html[add your ONTAP clusters] by going to the ONTAP tools menu in vCenter and clicking on _Storage backends_ and clicking the _add_ button.
** In a secure multitenant environment where you wish to delegate specific Storage Virtual Machines (SVMs) to specific vCenters, you must do the following.
*** Log into the ONTAP tools manager UI
*** https://docs.netapp.com/us-en/ontap-tools-vmware-vsphere-10/configure/add-storage-backend.html[Onboard the storage cluster]
*** https://docs.netapp.com/us-en/ontap-tools-vmware-vsphere-10/configure/associate-storage-backend.html[Associate a storage backend with a vCenter Server instance]
*** Provide the specific SVM credentials to the vCenter administrator who will then add the SVM as a storage backend in the ONTAP tools storage backends menu in vCenter.

[NOTE]
It is a best practice to create RBAC roles for your storage accounts. ONTAP tools 9.13 and later (including 10.X) include a JSON file containing the necessary role permissions neaded by ONTAP tools accounts. You can upload the JSON file to ONTAP System Manager to simplify the creation of RBAC roles and users. You can read more about ONTAP RBAC roles at https://docs.netapp.com/us-en/ontap-tools-vmware-vsphere-10/configure/configure-user-role-and-privileges.html#svm-aggregate-mapping-requirements[Configure ONTAP user roles and privileges].

[NOTE]
The reason that the entire cluster must be onboarded in the ONTAP tools manager UI is because many of the APIs used for vVols are only available at the cluster level.

[start=6]
. Use the _ONTAP tools_ menu in vCenter to start the _Provision datastore_ wizard.
[.thumb]
image:vvols-deploy-1.png[Provision datastore wizard]
* Choose vVols and provide a meaningful name and select the desired protocol. You may provide a description of the datastore as well.
** ONTAP tools 9.13
*** Select one or more SCPs to be supported by the vVols datastore. This will filter out any ONTAP systems which are unable to match the profile. From the resulting list, select your desired cluster and SVM.

*** Use the wizard to create new FlexVol volumes for each of the specified SCPs or use existing volumes by selecting the appropriate radio button.

*** Create VM policies for each SCP that will be used in the datastore from the _Policies and Profiles_ menu in the vCenter UI.

*** Choose the "NetApp.clustered.Data.ONTAP.VP.vvol" storage rule set. The "NetApp.clustered.Data.ONTAP.VP.VASA10" storage rule set is for SPBM support with non-vVols datastores

*** You will specify the Storage Capability Profile by name when creating a VM Storage Policy. While at this step, you may also configure SnapMirror policy matching by using the replication tab, and tag-based matching using the tags tab. Note that tags must already be created in order to be selectable.

** ONTAP tools 10.3 with ASA r2.

image:vvols-deploy-2.png[Provision datastore wizard]

*** Select the ASA r2 system SVM and click _next_.

image:vvols-deploy-3.png[Provision datastore wizard]

*** Click _finish_

image:vvols-deploy-4.png[Provision datastore wizard]

*** It's that easy!

** ONTAP tools 10.3 with ONTAP FAS, AFF, and ASA prior ASA r2.
*** Select the protocol

image:vvols-deploy-5.png[Provision datastore wizard]

*** Select the SVM and click _next_.

image:vvols-deploy-5a.png[Provision datastore wizard]

*** Click _add new volumes_ or _use existing volume_ and specify the attributes. Note that in ONTAP tools 10.3 you can request multiple volumes be created at the same time. You may also manually add multiple volumes to balance them across the ONTAP cluster. Click _next_

image:vvols-deploy-6.png[Provision datastore wizard]

image:vvols-deploy-7.png[Provision datastore wizard]

*** Click _finish_

image:vvols-deploy-8.png[Provision datastore wizard]

*** You can see the assigned volumes in the ONTAP tools menu of the configure tab for the datastore.

image:vvols-deploy-9.png[Provision datastore wizard]

** Now you can create VM storage policies from the _Policies and Profiles_ menu in the vCenter UI.

[start=7]
. Create your VMs, selecting a VM Storage Policy and compatible datastore under Select storage.

== Migrating VMs from traditional datastores to vVols
Migration of VMs from traditional datastores to a vVols datastore is as simple as moving VMs between traditional datastores. Simply select the VM(s), then select Migrate from the list of Actions, and select a migration type of _change storage only_. When prompted, select a VM storage policy that matches your vVols datastore. Migration copy operations can be offloaded with vSphere 6.0 and later for SAN VMFS to vVols migrations, but not from NAS VMDKs to vVols.

== Managing VMs with policies
To automate storage provisioning with policy based management, you need to create VM storage policies that map to the desired storage capabilities.

ONTAP tools 9.13 also requires you to define the capabilities of the storage (ONTAP node and FlexVol volume) with Storage Capability Profiles (SCPs).

[NOTE]
ONTAP tools 10.0 and later no longer use Storage Capability Profiles. Instead, the storage capabilities are defined directly in the VM storage policy itself.

NetApp has simplified the capabilities and mapping beginning with VASA Provider 7.2 with continuing improvements throughout later versions. This section focuses on this new approach. Earlier releases supported a greater number of capabilities and allowed them to be mapped individually to storage policies, but this approach is no longer supported.

=== Storage Capability Profile attributes used by ONTAP tools releases prior to 10.0.
[%autwidth.stretch,options="header",]
|===
| *SCP Capability* | *Capability Values* | *Release Supported* | *Notes*
| *Compression* | Yes, No, Any | All | Mandatory for AFF in 7.2 through 9.13.
| *Deduplication* | Yes, No, Any | All |M andatory for AFF in 7.2 through 9.13.
| *Encryption* | Yes, No, Any | 7.2 through 9.13 | Selects/creates encrypted FlexVol volume.. ONTAP license required.
| *Max IOPS* | <number> | 7.1 and later, but differences | Listed under QoS Policy Group for 7.2 through 9.13. See <<Performance management with ONTAP tools 9.10 and later>> for more information.
| *Personality* |A FF, FAS | 7.2 through 9.13 | FAS also includes other non-AFF systems, such as ONTAP Select. AFF includes ASA.
| *Protocol* | NFS, NFS 4.1, iSCSI, FCP, NVMe/FC, Any | 7.1 and earlier, 9.10 through 9.13 | 7.2-9.8 is effectively “Any”. Beginning again in 9.10 where NFS 4.1 and NVMe/FC were added to the original list.
| *Space Reserve (Thin Provisioning)* | Thin, Thick, (Any) | All, but differences | Called Thin Provisioning in 7.1 and earlier, which also allowed value of Any. Called Space Reserve in 7.2. All releases default to Thin.
| *Tiering Policy* | Any, None, Snapshot, Auto | 7.2 through 9.13 | Used for FabricPool - requires AFF or ASA with ONTAP 9.4 through 9.13. Only Snapshot is recommended unless using an on-premise S3 solution like NetApp StorageGRID.
|===

==== Creating Storage Capability Profiles in ONTAP tools 9.13
The NetApp VASA Provider comes with several pre-defined SCPs. New SCPs may be created manually, using the vCenter UI, or via automation using REST APIs. By specifying capabilities in a new profile, cloning an existing profile, or by auto-generating profile(s) from existing traditional datastores. This is done using the menus under ONTAP tools. Use _Storage Capability Profiles_ to create or clone a profile, and _Storage Mapping_ to auto-generate a profile. 

===== Storage Capabilities for ONTAP tools 9.10 and later
image:vvols-image9.png["Storage Capabilities for ONTAP tools 9.10 and later",300]

image:vvols-image12.png["Storage Capabilities for ONTAP tools 9.10 and later",300]

image:vvols-image11.png["Storage Capabilities for ONTAP tools 9.10 and later",300] 

image:vvols-image10.png["Storage Capabilities for ONTAP tools 9.10 and later",300]

image:vvols-image14.png["Storage Capabilities for ONTAP tools 9.10 and later",300]

image:vvols-image13.png["Storage Capabilities for ONTAP tools 9.10 and later",300]

*Creating vVols Datastores with ONTAP tools 9.X*
Once the necessary SCPs have been created, they may be used to create the vVols datastore (and optionally, FlexVol volumes for the datastore). Right-click on the host, cluster, or datacenter on which you want to create the vVols datastore, then select _ONTAP tools_ > _Provision Datastore_. Select one or more SCPs to be supported by the datastore, then select from existing FlexVol volumes and/or provision new FlexVol volumes for the datastore. Finally, specify the default SCP for the datastore, which will be used for VMs that do not have an SCP specified by policy, as well as for swap vVols (these do not require high performance storage).

=== Creating VM Storage Policies
VM Storage Policies are used in vSphere to manage optional features such as Storage I/O Control or vSphere Encryption. They are also used with vVols to apply specific storage capabilities to the VM. Use the “NetApp.clustered.Data.ONTAP.VP.vvol” storage type. See link:vmware-vvols-ontap.html#Best Practices[example network configuration using vVols over NFS v3] for an example of this with the ONTAP tools VASA Provider. Rules for “NetApp.clustered.Data.ONTAP.VP.VASA10” storage are to be used with non-vVols based datastores.

Earlier releases are similar, but as mentioned in <<Storage Capability Profile capabilities by ONTAP tools release>>, your options will vary.

Once the storage policy has been created, it can be used when provisioning new VMs as shown in link:vmware-vvols-overview.html#deploy-vm-using-storage-policy[Deploy VM using Storage Policy]. Guidelines for using performance management capabilities with VASA Provider 7.2 are covered in <<Performance management with ONTAP tools 9.10 and later>>.

==== VM storage policy creation with ONTAP tools VASA Provider 9.10
image:vvols-image15.png["VM Storage Policy creation with ONTAP tools VASA Provider 9.10",300]

==== Performance management with ONTAP tools 9.10 and later
* ONTAP tools 9.10 uses its own balanced placement algorithm to place a new vVol in the best FlexVol volume within a vVols datastore. Placement is based on matching FlexVol volumes. This makes sure that the datastore and backing storage can meet the specified performance requirements.

* Changing Performance capabilities such as Min and Max IOPS requires some attention to the specific configuration.
** *Min and Max IOPS* may be specified in an SCP and used in a VM Policy.
*** Changing the IOPS in the SCP will not change QoS on the vVols until the VM Policy is edited, and then reapplied to the VMs that use it (see <<Storage Capabilities for ONTAP tools 9.10 and later>>). Or create a new SCP with the desired IOPS and change the policy to use it (and reapply to VMs). Generally it is recommended to simply define separate SCPs and VM storage policies for different tiers of service and simply change the VM storage policy on the VM.
*** AFF and FAS personalities have different IOPs settings. Both Min and Max are available on AFF. However non-AFF systems can only use Max IOPs settings.

* In some cases, a vVol may need to be migrated after a policy change (either manually, or automatically by VASA Provider and ONTAP):
** Some changes require no migration (such as changing Max IOPS, which can be applied immediately to the VM as outlined above).
** If the policy change cannot be supported by the current FlexVol volume that stores the vVol (for example, the platform does not support the encryption or tiering policy requested), you will need to manually migrate the VM in vCenter.

* ONTAP tools creates individual non-shared QoS policies with currently supported versions of ONTAP. Therefore, each individual VMDK will receive its own allocation of IOPs.

===== Reapplying VM Storage Policy
image:vvols-image16.png["Reapplying VM Storage Policy",300]
